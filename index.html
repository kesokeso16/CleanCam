<!DOCT<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中尾式・清掃カメラ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    input, select { font-size: 20px; padding: 10px; margin: 10px; width: 80%; max-width: 400px; }
    .btn { font-size: 20px; padding: 15px 30px; border-radius: 8px; margin: 10px; cursor: pointer; border: none; }
    .main-btn { background-color: #007bff; color: white; }
    .save-btn { background-color: #28a745; color: white; }
    canvas { display: none; }
  </style>
</head>
<body>
  <h1>CLEAN CAM</h1>
  <input type="file" accept="image/*" capture="environment" id="photoInput"><br>
  <input type="text" placeholder="物件名" id="building"><br>
  <select id="floor"><option>1階</option><option>2階</option><option>3階</option></select><br>
  <input type="text" placeholder="部屋番" id="room"><br>
  <select id="location"><option>廊下</option><option>階段</option><option>トイレ</option></select><br>
  <select id="light"><option>LED</option><option>蛍光灯</option></select><br>
  <button class="btn main-btn" onclick="generateImage()">📸 記録画像作成</button>
  <button class="btn save-btn" onclick="downloadZip()">📦 ZIP保存</button>

  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="previewBox"></div>

  <script>
    let imageBlob;
    function generateImage() {
      const file = document.getElementById('photoInput').files[0];
      if (!file) return alert('写真撮って！');
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width; canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          ctx.font = '60px sans-serif';
          ctx.textAlign = 'right'; ctx.textBaseline = 'top';
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(canvas.width - 900, 20, 880, 300);
          ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
          const lines = [
            `📍 ${building.value} ${floor.value} ${room.value}`,
            `🧽 ${location.value}  💡${light.value}`,
            `📅 ${new Date().toLocaleString()}`
          ];
          lines.forEach((line, i) => {
            const y = 40 + i * 90;
            const x = canvas.width - 30;
            ctx.strokeText(line, x, y);
            ctx.fillText(line, x, y);
          });
          canvas.toBlob(blob => {
            imageBlob = blob;
            const url = URL.createObjectURL(blob);
            const imgEl = new Image();
            imgEl.src = url;
            imgEl.style = "max-width:100%;margin-top:20px;border:2px solid #ccc";
            const previewBox = document.getElementById('previewBox');
            previewBox.innerHTML = ''; previewBox.appendChild(imgEl);
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function downloadZip() {
      if (!imageBlob) return alert('先に画像作って');
      const zip = new JSZip();
      const now = new Date();
      const filename = `${building.value}_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}_${now.getHours()}-${now.getMinutes()}.png`;
      zip.file(filename, imageBlob);
      zip.generateAsync({type: "blob"}).then(function(content) {
        saveAs(content, "clean_photos.zip");
      });
    }
  </script>
</body>
</html>
